# Claude Code CLIProxy 에이전트 팀 구성 및 사용 가이드

## 1. 개요 및 배경

Claude Code의 강력한 기능 중 하나인 '에이전트 팀(Agent Team)' 기능을 `CLIProxyAPI` 프록시 환경에서 사용할 때 발생하는 문제점들을 분석하고, 이를 해결하기 위한 올바른 사용 패턴을 정의합니다.

### 1.1. 프록시 환경에서 관찰된 문제점

사용자가 프록시 런처(`cc-ag-claude`, `cc-codex` 등)를 통해 Claude Code를 실행한 후, 하위 에이전트를 호출(Spawn)할 때 다음과 같은 문제들이 발생할 수 있습니다.

1. **런처 우회 문제**: 지시 없이 팀원에게 일을 맡기면 `cc-ag-claude` 등의 프록시 런처를 쓰지 않고 순정 `claude` 바이너리를 직접 호출하려 시도합니다.
2. **모델 ID 불일치 (404 에러)**: 에이전트에게 런처를 쓰도록 강제하면, 에이전트가 스스로 모델을 선택하려다 `claude-3-5-sonnet-20241022`와 같은 구체적인 모델 ID를 인자로 넘깁니다. 프록시는 `claude-sonnet-4-6` 등 사전 정의된 식별자만 인식하므로 API 에러가 발생합니다.
3. **명시적 플래그(`--model`) 인식 오류**: 메인 세션이나 에이전트에서 명시적인 모델 플래그를 사용할 경우, Claude Code 내부 로직에 의해 기본 제공되는 티어가 아닌 '사용자 정의 커스텀 모델'로 취급되어 프록시 맵핑이 깨집니다.

---

## 2. 프로바이더(Provider) 상속 및 한계점 분석

에이전트 팀 구성 시 가장 중요한 개념은 **"팀 리더(메인 세션)와 팀원(하위 에이전트) 간의 프로바이더 분리가 불가능하다"**는 점입니다.

### 2.1. 환경 변수 상속의 원리

프록시 파이썬 코어(`python/cc_proxy.py`)는 메인 세션을 시작할 때 다음 환경 변수를 주입합니다.
* `ANTHROPIC_BASE_URL` (로컬 프록시 주소, 예: `http://127.0.0.1:18417`)
* `ANTHROPIC_DEFAULT_*_MODEL` (프록시가 인식하는 모델 매핑)

팀 리더(메인 세션)가 하위 에이전트 프로세스를 생성할 때, 이 환경 변수들은 **무조건 상속**됩니다. 따라서 하위 에이전트가 순정 `claude` 명령어를 실행하더라도, 부모가 사용 중인 프로바이더(포트)와 모델 매핑을 그대로 따라가게 됩니다.

### 2.2. 서로 다른 프로바이더 사용의 제약

현재 Claude Code의 `Task` 도구 구조상 다음과 같은 한계가 있습니다.
1. **동적 포트 변경 불가**: `Task` 도구는 에이전트의 역할(`subagent_type`)과 모델(`model`)은 지정할 수 있지만, `ANTHROPIC_BASE_URL`과 같은 환경 변수를 에이전트별로 다르게 오버라이드할 수 있는 기능이 없습니다.
2. **커스텀 에이전트(Custom Agent) 스크립트의 제약**: 이론적으로는 특정 프로바이더 전용 쉘 스크립트를 만들어 우회할 수 있으나, 설정이 매우 복잡해지고 유지보수가 어려워집니다.

**결론적으로 현재 프록시 아키텍처와 Claude Code의 한계로 인해, "하나의 팀(세션) 내에서 팀원마다 서로 다른 프로바이더(런처)를 사용하는 것은 불가능"하며, 모든 팀원은 팀 리더가 처음 시작한 프로바이더 환경을 강제로 공유하게 됩니다.**

---

## 3. 올바른 에이전트 팀 사용 가이드

이러한 제약 사항을 명확히 인지하고, 상황에 맞게 최적의 프로바이더와 모델을 선택해야 합니다.

### 3.1. 팀 리더의 프로바이더 선택 전략 (핵심)

팀 리더는 모든 하위 에이전트의 API 요청을 책임지는 '통로'가 되므로, 작업의 복잡도와 예산(토큰 제한)을 고려하여 신중하게 런처를 선택해야 합니다.

* **`cc-codex` (추천 - 대규모 작업/팀 워크)**: ChatGPT Pro 등 토큰 제한량이 넉넉한 환경에 연결된 경우 추천합니다. 팀원들이 병렬로 대량의 코드 탐색이나 계획 수립을 수행해도 Rate Limit에 걸릴 확률이 낮습니다. *(주의: 메인 세션 실행 후 프롬프트에서 Opus 티어 선택 필수)*
* **`cc-ag-claude` / `cc-ag-gemini` (추천 - 고품질 단일/소규모 작업)**: 매우 높은 품질의 코딩이나 복잡한 논리 추론이 필요하지만, 팀원들의 대량 호출보다는 리더 주도의 정밀한 작업이 중심이 될 때 사용합니다.

### 3.2. 에이전트 호출 (Spawning) 및 모델 규칙

프록시 환경에서 에이전트 팀을 안전하게 운영하기 위해 다음 규칙을 준수해야 합니다.

1. **런처 강제 금지**: 하위 에이전트에게 런처(`cc-ag-claude` 등) 사용을 지시하지 않습니다. 자연스러운 환경 변수 상속을 통해 순정 `claude` 바이너리가 프록시를 타도록 유도합니다.
2. **모델 선택 통제**: 팀 리더는 에이전트에게 모델 선택을 위임하지 않습니다.
3. **`model` 파라미터 제약**: 에이전트 생성 시 모델 파라미터는 생략(`sonnet` 기본값)하거나 목적에 따라 `"sonnet"`, `"opus"`, `"haiku"` 중 하나를 명시적으로 지정할 수 있습니다. (proxy 환경에서 구체적 모델명인 `claude-3-5-sonnet-20241022` 등 임의 ID 지정 시 404 에러가 발생합니다)
4. **`--model` 플래그 사용 금지**: 메인 세션 시작 시 `--model` 플래그를 붙이지 않고 런처 이름만으로 실행합니다. (예: `cc-ag-claude` O, `cc-ag-claude --model sonnet` X)

### 3.3. 응답 없는 팀원 관리

에이전트가 프록시 오류나 다른 이유로 멈춰서 종료 요청(`shutdown_request`)을 무시하는 경우, 다음 방법으로 프로세스를 직접 종료해야 합니다.

```bash
# 에이전트 PID 확인
ps aux | grep "agent-name <에이전트_이름>"

# 프로세스 종료
kill <PID>
```
팀원 프로세스는 `--agent-name`, `--team-name`, `--model` 플래그로 식별 가능합니다.
