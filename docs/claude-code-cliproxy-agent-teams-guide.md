# Claude Code CLIProxy 에이전트 팀 구성 및 사용 가이드 (최신)

## 1. 개요 및 배경

Claude Code의 '에이전트 팀(Agent Team)' 기능을 `CLIProxyAPI` 프록시 환경에서 사용할 때 발생하는 **404 에러(Model Not Found)**의 근본 원인을 해결하고, 모든 프로바이더에서 안정적으로 팀원을 호출하는 방법을 정의합니다.

### 1.1. 404 에러의 근본 원인과 해결 (2026-02-25 검증)

과거에 발생했던 404 에러는 프로바이더의 종류 때문이 아니라, **환경 변수 주입의 불완전함** 때문이었습니다.

*   **원인**: Claude Code는 명시적인 모델 지정이 없을 때 내부적인 하드코딩 모델명(예: `claude-3-5-sonnet-20241022`)을 사용합니다. 프록시가 이 이름을 인식하지 못하면 404 에러가 발생합니다.
*   **해결**: 프록시 런처(`python/cc_proxy.py`)가 다음 **3가지 티어 환경 변수**를 모두 주입함으로써 해결되었습니다.
    *   `ANTHROPIC_DEFAULT_OPUS_MODEL`
    *   `ANTHROPIC_DEFAULT_SONNET_MODEL`
    *   `ANTHROPIC_DEFAULT_HAIKU_MODEL`
*   **결과**: 이 변수들이 설정되어 있으면 Claude Code는 하드코딩된 이름 대신 해당 변수값을 사용하며, 프록시는 이를 자신의 `PRESETS` 설정에 따라 백엔드 모델로 정확히 매핑합니다.

---

## 2. 프로바이더별 검증 결과 및 동작 원리

현재 제공되는 4개의 모든 프로바이더에서 에이전트 팀 기능이 완벽하게 동작함을 확인했습니다.

| 프로바이더 런처 | 포트 | 티어별 매핑 특징 |
|:---:|:---:|:---|
| `cc-ag-claude` / `cc-ag-gemini` | 18417 | **antigravity**: Haiku 티어 요청 시 자동으로 Sonnet으로 매핑됨 (의도적 설계) |
| `cc-claude` | 18418 | **claude**: 정식 Claude 모델들(`opus-4-6`, `sonnet-4-6`, `haiku-4-5`)에 1:1 매핑 |
| `cc-codex` | 18419 | **codex**: `gpt-5.3-codex` 계열의 high/xhigh/spark 모델로 매핑 |
| `cc-gemini` | 18420 | **gemini**: Google `gemini-3-pro`, `gemini-3-flash` 등 최신 모델로 매핑 |

### 2.1. 세션 재개(Resume) 시 주의사항

*   **동일 프로바이더 내 재개**: `cc-ag-claude` ↔ `cc-ag-gemini` 처럼 같은 포트(18417)를 쓰는 런처끼리는 세션 재개가 원활합니다.
*   **교차 프로바이더 재개**: 서로 다른 포트를 쓰는 프로바이더(예: `cc-claude` → `cc-codex`) 간에도 기본적으로는 재개가 가능합니다.
*   **주의**: 하지만 이전 세션에 특정 프로바이더 전용 모델 ID(예: `claude-opus-4-6-thinking`)가 히스토리에 강하게 남아있고, 새 프로바이더가 이를 지원하지 않는 경우 예외적으로 404가 발생할 수 있습니다. 이럴 때는 새 세션으로 시작하는 것을 권장합니다.

---

## 3. 올바른 에이전트 팀 사용 규칙

1.  **모델 티어 명시**: `Task` 도구 사용 시 `model` 파라미터에 `\"haiku\"`, `\"sonnet\"`, `\"opus\"` 중 하나를 명시하는 것을 권장합니다. (프록시가 가장 안전하게 매핑할 수 있는 방법입니다.)
2.  **구체적 모델명 사용 금지**: `Task` 호출 시 `claude-3-5-sonnet-20241022`와 같은 실제 모델 ID를 직접 입력하지 마십시오. 반드시 티어명(`haiku`, `sonnet`, `opus`)만 사용해야 합니다.
3.  **환경 변수 상속 활용**: 하위 에이전트에게 별도의 런처를 실행하라고 지시할 필요가 없습니다. 부모 세션의 프록시 환경 변수가 자동으로 상속되어 모든 에이전트의 API 요청은 팀 리더가 설정한 프록시 포트를 통하게 됩니다.
4.  **팀 리더의 선택**: 대규모 병렬 작업(에이전트 다수 호출) 시에는 Rate Limit이 넉넉한 `cc-codex` 프로바이더를 리더로 사용하는 것이 가장 유리합니다.

---

## 4. 문제 해결 (Troubleshooting)

### 4.1. 응답 없는 팀원 강제 종료

에이전트가 `shutdown_request`에 응답하지 않고 무한 루프나 오류에 빠진 경우:

```bash
# 에이전트 프로세스 확인 (이름으로 필터링)
ps aux | grep "agent-name <에이전트이름>"

# 해당 PID 종료
kill <PID>
```

---
*최종 업데이트: 2026-02-25 (cc-gemini 전수 검증 완료)*
